# STM32-uCOS
# 1 UCOSIII简单介绍
UCOS是Micrium公司出品的RTOS类实时操作系统， UCOS目前有两个版本：UCOSII和UCOSIII。

UCOSIII是一个可裁剪、可剥夺型的多任务内核，而且没有任务数限制，提供了实时操作系统所需的所有功能，包括资源管理、同步、任务通信等。

UCOSIII是用C和汇编来写的，其中绝大部分都是用C语言编写的，只有极少数的与处理器密切相关的部分代码才是用汇编写的， UCOSIII结构简洁，可读性很强！非常适合初次接触嵌入式实时操作系统学生、嵌入式系统开发人员和爱好者学习。

什么是任务？

任务（线程）是简单的程序。单CPU 中，在任何时刻只能是一个任务被执行。
任务看起来像C 函数。在大多数嵌入式系统中，任务通常是无限循环的。任务不能像C 函数那样，它是不能return 的。

在UCOSIII中任务是以何种面貌存在的呢？

在UCOSIII中任务就是程序实体，UCOSIII能够管理和调度这些小任务（程序）。UCOSIII中的任务由三部分组成：**任务堆栈、任务控制块和任务函数**。

- **任务堆栈**：上下文切换的时候用来保存任务的工作环境，就是STM32的内部寄存器值。

任务堆栈是任务的重要部分，堆栈是在RAM中按照“先进先出（FIFO）”的原则组织的一块连续的存储空间。为了满足任务切换和响应中断时保存CPU寄存器中的内容及任务调用其它函数时的需要，每个任务都应该有自己的堆栈。

> #define START_STK_SIZE 512 //堆栈大小
CPU_STK START_TASK_STK[START_STK_SIZE]; //定义一个数组来作为任务堆栈
任务堆栈初始化

任务如何才能切换回上一个任务并且还能接着从上次被中断的地方开始运行？

恢复现场即可，现场就是**CPU的内部各个寄存器**。因此在创建一个新任务时，必须把系统启动这个任务时所需的CPU各个寄存器初始值事先存放在任务堆栈中。这样**当任务获得CPU使用权时，就把任务堆栈的内容复制到CPU的各个寄存器**，从而可以任务顺利地启动并运行。

把任务初始数据存放到任务堆栈的工作就叫做任务堆栈的初始化，UCOSIII提供了完成堆栈初始化的函数：OSTaskStkInit()。

当然，用户一般不会直接操作堆栈初始化函数，**任务堆栈初始化函数由任务创建函数OSTaskCreate()调用**。不同的CPU对于的寄存器和对堆栈的操作方式不同，因此在移植UCOSIII的时候需要用户根据各自所选的CPU来编写任务堆栈初始化函数。

- **任务控制块**：任务控制块用来记录任务的各个属性。
任务控制块是用来记录与任务相关的信息的数据结构，每个任务都要有自己的任务控制块。我们使用OSTaskCreate()函数来创建任务的时候就会给任务分配一个任务控制块。任务控制块由用户自行创建。

> OS_TCB StartTaskTCB; //创建一个任务控制块

**USOCIII提供了用于任务控制块初始化的函数**：**OS_TaskInitTCB()**。但是，用户不需要自行初始化任务控制块。因为和任务堆栈初始化函数一样，函数OSTaskCreate()在创建任务的时候会对任务的任务控制块进行初始化。

- **任务函数**：由用户编写的任务处理代码，是实实在在干活的，任务函数通常是一个无限循环，也可以是一个只执行一次的任务。任务的参数是一个void类型的，可以可以传递不同类型的数据甚至是函数。
任务函数其实就是一个C语言的函数，但是在使用UCOIII的情况下这个函数不能有用户自行调用，任务函数何时执行执行，何时停止完全有操作系统来控制。

**UCOSIII支持时间片轮转调度，因此在一个优先级下会有多个任务，那么我们就要对这些任务做一个管理，这里使用OSRdyList[]数组管理这些任务。**

OSRdyList[]数组中的每个元素对应一个优先级，比如OSRdyList[0]就用来管理优先级0下的所有任务。OSRdyList[0]为OS_RDY_LIST类型，从上面OS_RDY_LIST结构体可以看到成员变量：HeadPtr和TailPtr分别指向OS_TCB，我们知道OS_TCB是可以用来构造链表的，因此同一个优先级下的所有任务是通过链表来管理的，HeadPtr和TailPtr分别指向这个链表的头和尾，NbrEntries用来记录此优先级下的任务数量，图5.5.2表示了优先级4现在有3个任务时候的就绪任务列表。

**同一优先级下如果有多个任务的话最先运行的永远是HeadPtr所指向的任务**

![在这里插入图片描述](https://img-blog.csdnimg.cn/7c8f704a6baa4008adae3cb36c36e714.png)
